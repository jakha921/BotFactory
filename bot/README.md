# Bot Factory - Telegram Bot (aiogram)

Telegram bot для платформы Bot Factory на базе aiogram 3.x.

## Установка

### Вариант 1: Используя setup скрипт (рекомендуется)

```bash
cd bot
./setup.sh
```

Этот скрипт автоматически:
- Создаст виртуальное окружение (если его нет)
- Установит все зависимости
- Покажет инструкции для запуска

### Вариант 2: Вручную

1. Создайте виртуальное окружение:
```bash
cd bot
python -m venv .venv
source .venv/bin/activate  # Linux/Mac
# или
.venv\Scripts\activate  # Windows
```

2. Установите зависимости:
```bash
pip install --upgrade pip
pip install -r requirements.txt
```

3. Создайте `.env` файл:
```bash
cp .env.example .env
```

4. Настройте переменные окружения в `.env`:
```env
TELEGRAM_BOT_TOKEN=your_telegram_bot_token_here
DJANGO_API_BASE_URL=http://localhost:8000/api/v1
DJANGO_SETTINGS_MODULE=bot_factory.settings.development
LOG_LEVEL=INFO
ADMIN_IDS=123456789,987654321
```

## Запуск

### Вариант 1: Используя uv (рекомендуется)

```bash
# Из корня проекта (важно!)
cd /Users/jakha/Programming/Django/bot-factory

# Используя скрипт (рекомендуется - автоматически установит PYTHONPATH)
./bot/run_uv.sh

# Или вручную:
export PYTHONPATH="$(pwd):$PYTHONPATH"
cd bot
uv run python main.py
```

**ВАЖНО:** Запускать нужно из корня проекта, чтобы Python мог найти модуль `bot`!

### Вариант 2: Используя скрипт (без uv)

```bash
# Из директории bot/
./run.sh

# Или из корня проекта
./bot/run_bot.sh
```

### Вариант 3: Вручную (из корня проекта)

```bash
# ВАЖНО: Запускать из корня проекта, не из bot/
cd /path/to/bot-factory

# Установить PYTHONPATH
export PYTHONPATH="$(pwd):$PYTHONPATH"

# Активировать виртуальное окружение
cd bot
source .venv/bin/activate  # или venv/bin/activate

# Запустить
python main.py
```

**ВАЖНО:** Бот должен запускаться из корня проекта или через скрипт, который устанавливает PYTHONPATH правильно, иначе будет ошибка `ModuleNotFoundError: No module named 'bot'`.

## Установка с помощью uv

Если вы используете `uv` для управления зависимостями:

```bash
cd bot

# Установить зависимости (создаст .venv автоматически, если нужно)
uv pip install -r requirements.txt

# Запустить бота
export PYTHONPATH="$(cd .. && pwd):$PYTHONPATH"
python main.py

# Или используя скрипт (автоматически установит PYTHONPATH)
./run_uv.sh

# Или использовать setup скрипт
./setup_uv.sh
```

**Преимущества uv:**
- Быстрая установка зависимостей
- Автоматическое создание виртуального окружения (при использовании venv)
- Управление зависимостями через `pyproject.toml` (для справки)

**Примечание:** Для простоты используем `uv pip install` вместо `uv sync`, так как нам не нужно собирать пакет - достаточно установить зависимости.

## Структура

- `handlers/` - Обработчики сообщений и команд
- `services/` - Бизнес-логика и сервисы
- `integrations/` - Интеграция с Django backend
- `keyboards/` - Динамические клавиатуры
- `states/` - FSM состояния для форм
- `utils/` - Утилиты (keyboard_builder, form_builder)

## Интеграция с Backend

Бот интегрируется с Django backend через:
1. Django ORM (для доступа к моделям Bot, TelegramUser, ChatSession, etc.)
2. Backend services (Gemini API, transcription, file processing)
3. HTTP API (для транскрипции аудио и обработки файлов)

## Обработка сообщений

Бот поддерживает:
- Текстовые сообщения
- Голосовые сообщения (транскрипция)
- Аудио файлы
- Документы (PDF, DOCX, TXT, MD)
- Изображения

## Динамическая конфигурация

UI элементы (клавиатуры, формы) настраиваются через веб-интерфейс и загружаются из Django backend.

## Мультибот поддержка

Бот поддерживает одновременный запуск нескольких ботов:
- Все активные боты (status='active') автоматически загружаются при старте
- BotMonitor периодически проверяет изменения в БД и автоматически добавляет/удаляет/перезапускает боты
- Каждый бот работает независимо в отдельной asyncio.Task
- При падении одного бота остальные продолжают работать

## Динамическая перезагрузка

BotMonitor автоматически отслеживает изменения в БД:
- Новые активные боты автоматически запускаются
- Удаленные или деактивированные боты автоматически останавливаются
- Изменения в конфигурации бота (токен, статус, etc.) автоматически перезапускают бот
- Интервал проверки: 30 секунд (конфигурируется)

## Управление ботами

### Через веб-интерфейс:
- Test Connection: проверка токена через Telegram API
- Bot Status: отображение статуса бота (запущен/остановлен)
- Restart Bot: отправка сигнала перезапуска боту

### Через API:
- `GET /api/v1/bots/{id}/bot-status/` - получить статус бота
- `POST /api/v1/bots/{id}/restart-bot/` - перезапустить бота
- `GET /api/v1/bots/{id}/test-telegram-connection/` - проверить подключение

## Безопасность

- Telegram токены хранятся в зашифрованном виде в БД (используется Fernet encryption)
- Шифрование автоматически применяется при сохранении токена
- Токены расшифровываются только при использовании

## Troubleshooting

### Бот не отвечает на сообщения:
1. Проверьте, что бот запущен (статус в веб-интерфейсе)
2. Проверьте логи бота на наличие ошибок
3. Проверьте, что `chat_router` включен в `main.py`
4. Проверьте, что бот имеет статус 'active' в БД

### Конфликты при запуске:
- Если появляется `TelegramConflictError`, значит другой экземпляр бота уже запущен
- Остановите все процессы бота перед запуском нового
- Проверьте, нет ли других запущенных процессов: `ps aux | grep main.py`

### Боты не перезагружаются автоматически:
- Проверьте, что BotMonitor запущен (должен быть в логах)
- Проверьте интервал проверки (по умолчанию 30 секунд)
- Проверьте логи BotMonitor на наличие ошибок
