# Bot Factory - Bot (aiogram) Cursor Rules

## üìã –û–±–∑–æ—Ä –ü—Ä–æ–µ–∫—Ç–∞

Bot Factory ‚Äî SaaS-–ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è AI-–±–æ—Ç–∞–º–∏ —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π Telegram –∏ Google Gemini.
Bot –º–æ–¥—É–ª—å –Ω–∞ aiogram 3.x –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç Telegram –±–æ—Ç–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã.
–ú–æ–Ω–æ—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: `bot/` (aiogram) + `backend/` (Django) + `frontend/` (React).

---

## üõ†Ô∏è –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –°—Ç–µ–∫ Bot

### Framework & Core
- **Framework:** aiogram 3.x (async/await)
- **Language:** Python 3.11+ (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ñ–∏—á–∏, type hints)
- **Async Runtime:** asyncio (aiogram –∏—Å–ø–æ–ª—å–∑—É–µ—Ç async/await)
- **Database:** PostgreSQL 15+ (—á–µ—Ä–µ–∑ Django ORM —Å asgiref.sync.sync_to_async)

### –û—Å–Ω–æ–≤–Ω—ã–µ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏
- **aiogram 3.x:** Async Telegram Bot API framework
- **Django ORM:** –î–æ—Å—Ç—É–ø –∫ –º–æ–¥–µ–ª—è–º —á–µ—Ä–µ–∑ `asgiref.sync.sync_to_async`
- **google-generativeai:** Google Gemini API integration (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç backend services)
- **aiohttp / httpx:** HTTP –∫–ª–∏–µ–Ω—Ç –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
- **python-dotenv:** –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### AI & Integrations
- **Backend Services:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å backend/services/ (gemini.py, transcription.py, file_processing.py)
- **Django API:** –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å backend —á–µ—Ä–µ–∑ HTTP API –∏–ª–∏ –ø—Ä—è–º—ã–µ –∏–º–ø–æ—Ä—Ç—ã
- **Google Gemini API:** –ß–µ—Ä–µ–∑ backend/services/gemini.py

### Utilities & Development
- **black:** –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
- **ruff / flake8:** –õ–∏–Ω—Ç–∏–Ω–≥
- **mypy:** Type checking (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
- **pytest-asyncio:** –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- **uv:** –ú–µ–Ω–µ–¥–∂–µ—Ä –ø–∞–∫–µ—Ç–æ–≤ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤–º–µ—Å—Ç–æ pip)

---

## üìÅ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ü—Ä–æ–µ–∫—Ç–∞ Bot

```
bot/
‚îú‚îÄ‚îÄ bot_factory_bot/          # –ì–ª–∞–≤–Ω—ã–π –ø–∞–∫–µ—Ç –±–æ—Ç–∞
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ config.py             # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (settings, env vars)
‚îÇ   ‚îú‚îÄ‚îÄ dispatcher.py         # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ dispatcher –∏ routers
‚îÇ   ‚îú‚îÄ‚îÄ filters.py            # –ö–∞—Å—Ç–æ–º–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã (BotOwner, Admin, etc.)
‚îÇ   ‚îú‚îÄ‚îÄ middleware.py         # Middleware (Logging, RateLimit, etc.)
‚îÇ   ‚îî‚îÄ‚îÄ utils.py              # –û–±—â–∏–µ —É—Ç–∏–ª–∏—Ç—ã
‚îú‚îÄ‚îÄ handlers/                 # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –∫–æ–º–∞–Ω–¥
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ start.py              # /start –∫–æ–º–∞–Ω–¥–∞ –∏ –Ω–∞—á–∞–ª–æ –¥–∏–∞–ª–æ–≥–∞
‚îÇ   ‚îú‚îÄ‚îÄ chat.py               # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ commands.py           # –û–±—â–∏–µ –∫–æ–º–∞–Ω–¥—ã (/help, /settings)
‚îÇ   ‚îú‚îÄ‚îÄ admin.py              # –ê–¥–º–∏–Ω—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
‚îÇ   ‚îî‚îÄ‚îÄ callbacks.py          # –û–±—Ä–∞–±–æ—Ç–∫–∞ callback queries (–∫–Ω–æ–ø–∫–∏)
‚îú‚îÄ‚îÄ services/                 # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∏ —Å–µ—Ä–≤–∏—Å—ã
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ bot_service.py        # –†–∞–±–æ—Ç–∞ —Å Bot –º–æ–¥–µ–ª—å—é (Django)
‚îÇ   ‚îú‚îÄ‚îÄ user_service.py       # –†–∞–±–æ—Ç–∞ —Å TelegramUser –º–æ–¥–µ–ª—å—é (Django)
‚îÇ   ‚îú‚îÄ‚îÄ chat_service.py       # –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–π –∏ —Å–æ–æ–±—â–µ–Ω–∏–π (Django)
‚îÇ   ‚îú‚îÄ‚îÄ knowledge_service.py  # –ü–æ–ª—É—á–µ–Ω–∏–µ knowledge base –¥–ª—è –±–æ—Ç–∞ (Django)
‚îÇ   ‚îú‚îÄ‚îÄ gemini_client.py      # –ö–ª–∏–µ–Ω—Ç –¥–ª—è Gemini API (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç backend)
‚îÇ   ‚îî‚îÄ‚îÄ message_processor.py  # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (—Ç–µ–∫—Å—Ç, –∞—É–¥–∏–æ, —Ñ–∞–π–ª—ã)
‚îú‚îÄ‚îÄ keyboards/                # Inline –∏ Reply –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ main.py               # –ì–ª–∞–≤–Ω—ã–µ –º–µ–Ω—é
‚îÇ   ‚îî‚îÄ‚îÄ settings.py           # –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã –Ω–∞—Å—Ç—Ä–æ–µ–∫
‚îú‚îÄ‚îÄ states/                   # FSM (Finite State Machine) —Å–æ—Å—Ç–æ—è–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îî‚îÄ‚îÄ chat.py               # –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —á–∞—Ç–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
‚îú‚îÄ‚îÄ integrations/             # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å backend
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ django_orm.py         # –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Django ORM
‚îÇ   ‚îî‚îÄ‚îÄ api_client.py         # HTTP –∫–ª–∏–µ–Ω—Ç –¥–ª—è backend API (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
‚îú‚îÄ‚îÄ utils/                    # –£—Ç–∏–ª–∏—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ logging.py            # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ text_processing.py    # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ (markdown, –æ—á–∏—Å—Ç–∫–∞)
‚îÇ   ‚îî‚îÄ‚îÄ rate_limiter.py       # Rate limiting –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚îú‚îÄ‚îÄ requirements/
‚îÇ   ‚îú‚îÄ‚îÄ base.txt              # –ë–∞–∑–æ–≤—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îÇ   ‚îú‚îÄ‚îÄ development.txt       # Dev –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îÇ   ‚îî‚îÄ‚îÄ production.txt        # Prod –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ main.py                   # Entry point –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞
‚îú‚îÄ‚îÄ .env.example              # –ü—Ä–∏–º–µ—Ä –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ .gitignore
‚îî‚îÄ‚îÄ README.md
```

---

## üèóÔ∏è –ü–∞—Ç—Ç–µ—Ä–Ω—ã –ö–æ–¥–∞ aiogram

### 1. Dispatcher –∏ Router Setup

**–ü—Ä–∞–≤–∏–ª–∞:**
- –ò—Å–ø–æ–ª—å–∑—É–π Router –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ handlers
- –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π routers –≤ dispatcher
- –ò—Å–ø–æ–ª—å–∑—É–π middleware –¥–ª—è –æ–±—â–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, rate limiting)

**–ü—Ä–∏–º–µ—Ä:**
```python
# bot_factory_bot/dispatcher.py
from aiogram import Dispatcher
from aiogram.filters import Command
from aiogram.types import Message
from handlers.start import start_router
from handlers.chat import chat_router
from handlers.commands import commands_router
from middleware import LoggingMiddleware, RateLimitMiddleware

def setup_dispatcher(dp: Dispatcher) -> Dispatcher:
    """Setup dispatcher with routers and middleware."""
    # Register middleware (order matters!)
    dp.message.middleware(LoggingMiddleware())
    dp.message.middleware(RateLimitMiddleware())
    
    # Register routers
    dp.include_router(start_router)
    dp.include_router(chat_router)
    dp.include_router(commands_router)
    
    return dp
```

### 2. Handlers (–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏)

**–ü—Ä–∞–≤–∏–ª–∞:**
- –í—Å–µ handlers ‚Äî async —Ñ—É–Ω–∫—Ü–∏–∏
- –ò—Å–ø–æ–ª—å–∑—É–π Router –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –ø–æ—Ö–æ–∂–∏—Ö handlers
- –ò—Å–ø–æ–ª—å–∑—É–π –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã `@router.message()`, `@router.callback_query()`
- –§–∏–ª—å—Ç—Ä—É–π –ø–æ —Ç–∏–ø–∞–º —Å–æ–æ–±—â–µ–Ω–∏–π (text, audio, document, photo)

**–ü—Ä–∏–º–µ—Ä:**
```python
# handlers/start.py
from aiogram import Router
from aiogram.filters import Command
from aiogram.types import Message
from aiogram.fsm.context import FSMContext
from services.bot_service import get_user_bot
from services.user_service import get_or_create_telegram_user
from keyboards.main import get_main_menu

start_router = Router()

@start_router.message(Command("start"))
async def cmd_start(message: Message, state: FSMContext):
    """Handle /start command."""
    user = message.from_user
    bot_token = message.bot.token
    
    # Get bot instance using Django ORM
    bot = await get_user_bot(bot_token)
    if not bot:
        await message.answer("‚ùå –ë–æ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω.")
        return
    
    # Get or create Telegram user
    telegram_user = await get_or_create_telegram_user(
        bot=bot,
        telegram_id=user.id,
        username=user.username,
        first_name=user.first_name,
        last_name=user.last_name
    )
    
    # Clear any existing state
    await state.clear()
    
    # Send welcome message
    welcome_text = f"üëã –ü—Ä–∏–≤–µ—Ç, {user.first_name}!\n\n"
    welcome_text += f"–Ø {bot.name}. {bot.description or '–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?'}"
    
    await message.answer(
        welcome_text,
        reply_markup=get_main_menu()
    )
```

### 3. Services (–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞)

**–ü—Ä–∞–≤–∏–ª–∞:**
- –í—ã–Ω–æ—Å–∏ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –∏–∑ handlers –≤ services
- –ò—Å–ø–æ–ª—å–∑—É–π `asgiref.sync.sync_to_async` –¥–ª—è Django ORM –æ–ø–µ—Ä–∞—Ü–∏–π
- –í—Å–µ service —Ñ—É–Ω–∫—Ü–∏–∏ ‚Äî async
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π –∏—Å–∫–ª—é—á–µ–Ω–∏—è –≤ services

**–ü—Ä–∏–º–µ—Ä:**
```python
# services/bot_service.py
from asgiref.sync import sync_to_async
from typing import Optional
from django.core.exceptions import ObjectDoesNotExist
import os

# Import Django models (–Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å Django settings)
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'bot_factory.settings.development')
import django
django.setup()

from apps.bots.models import Bot

@sync_to_async
def get_user_bot(telegram_token: str) -> Optional[Bot]:
    """
    Get bot by telegram token.
    
    Args:
        telegram_token: Telegram bot token
        
    Returns:
        Bot instance or None if not found
    """
    try:
        bot = Bot.objects.get(
            telegram_token=telegram_token,
            status='active'  # Only active bots
        )
        return bot
    except ObjectDoesNotExist:
        return None

@sync_to_async
def get_bot_knowledge_base(bot_id: str) -> dict:
    """
    Get knowledge base (snippets and documents) for bot.
    
    Args:
        bot_id: Bot UUID
        
    Returns:
        Dict with 'snippets' and 'documents' lists
    """
    from apps.knowledge.models import TextSnippet, Document
    
    bot = Bot.objects.get(id=bot_id)
    
    snippets = list(
        TextSnippet.objects.filter(bot=bot).values(
            'title', 'content', 'tags'
        )
    )
    
    documents = list(
        Document.objects.filter(bot=bot, status='ready').values(
            'name', 'type'
        )
    )
    
    return {
        'snippets': snippets,
        'documents': documents
    }
```

### 4. Django ORM Integration

**–ü—Ä–∞–≤–∏–ª–∞:**
- –ò—Å–ø–æ–ª—å–∑—É–π `asgiref.sync.sync_to_async` –¥–ª—è Django ORM –æ–ø–µ—Ä–∞—Ü–∏–π
- –ù–∞—Å—Ç—Ä–æ–π Django settings –ø–µ—Ä–µ–¥ –∏–º–ø–æ—Ä—Ç–æ–º –º–æ–¥–µ–ª–µ–π
- –°–æ–∑–¥–∞–π –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–æ–¥—É–ª—å –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Django

**–ü—Ä–∏–º–µ—Ä:**
```python
# integrations/django_orm.py
import os
import django
from asgiref.sync import sync_to_async
from typing import Optional, List, Dict, Any

# Initialize Django
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'bot_factory.settings.development')
django.setup()

from apps.bots.models import Bot
from apps.telegram.models import TelegramUser
from apps.chat.models import ChatSession, ChatMessage
from apps.knowledge.models import TextSnippet, Document

# Async wrappers for Django ORM operations
@sync_to_async
def get_bot_by_token(telegram_token: str) -> Optional[Bot]:
    """Get active bot by telegram token."""
    try:
        return Bot.objects.get(
            telegram_token=telegram_token,
            status='active'
        )
    except Bot.DoesNotExist:
        return None

@sync_to_async
def get_or_create_telegram_user(
    bot: Bot,
    telegram_id: int,
    username: Optional[str] = None,
    first_name: str = "",
    last_name: Optional[str] = None
) -> TelegramUser:
    """Get or create Telegram user."""
    user, created = TelegramUser.objects.get_or_create(
        telegram_id=telegram_id,
        bot=bot,
        defaults={
            'username': username,
            'first_name': first_name,
            'last_name': last_name,
            'status': 'active'
        }
    )
    
    # Update last_active
    user.last_active = django.utils.timezone.now()
    user.message_count += 1
    user.save(update_fields=['last_active', 'message_count'])
    
    return user

@sync_to_async
def create_chat_session(bot: Bot, telegram_user: TelegramUser) -> ChatSession:
    """Create new chat session."""
    session = ChatSession.objects.create(
        bot=bot,
        user=telegram_user
    )
    return session

@sync_to_async
def save_chat_message(
    session: ChatSession,
    role: str,
    content: str,
    is_thinking: bool = False,
    attachments: Optional[Dict[str, Any]] = None
) -> ChatMessage:
    """Save chat message to database."""
    message = ChatMessage.objects.create(
        session=session,
        role=role,
        content=content,
        is_thinking=is_thinking,
        attachments=attachments or {}
    )
    return message

@sync_to_async
def get_chat_history(session: ChatSession, limit: int = 10) -> List[Dict[str, str]]:
    """Get chat history as list of {role, content} dicts."""
    messages = ChatMessage.objects.filter(
        session=session
    ).order_by('-timestamp')[:limit]
    
    history = []
    for msg in reversed(messages):  # Oldest first
        history.append({
            'role': msg.role,
            'content': msg.content
        })
    
    return history
```

### 5. Message Processing (–¢–µ–∫—Å—Ç, –ê—É–¥–∏–æ, –§–∞–π–ª—ã)

**–ü—Ä–∞–≤–∏–ª–∞:**
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (text, audio, voice, document, photo)
- –î–ª—è –∞—É–¥–∏–æ: –æ—Ç–ø—Ä–∞–≤–ª—è–π –Ω–∞ backend –¥–ª—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏
- –î–ª—è —Ñ–∞–π–ª–æ–≤: –æ—Ç–ø—Ä–∞–≤–ª—è–π –Ω–∞ backend –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
- –ò—Å–ø–æ–ª—å–∑—É–π backend API endpoints –∏–ª–∏ –ø—Ä—è–º—ã–µ –∏–º–ø–æ—Ä—Ç—ã services

**–ü—Ä–∏–º–µ—Ä:**
```python
# handlers/chat.py
from aiogram import Router, F
from aiogram.types import Message
from aiogram.fsm.context import FSMContext
from services.message_processor import process_message
from services.gemini_client import generate_bot_response
from integrations.django_orm import (
    get_bot_by_token,
    get_or_create_telegram_user,
    create_chat_session,
    get_chat_history,
    save_chat_message
)

chat_router = Router()

@chat_router.message(F.content_type.in_(['text', 'voice', 'audio', 'document', 'photo']))
async def handle_message(message: Message, state: FSMContext):
    """Handle incoming messages (text, audio, files)."""
    user = message.from_user
    bot_token = message.bot.token
    
    # Get bot instance
    bot = await get_bot_by_token(bot_token)
    if not bot:
        await message.answer("‚ùå –ë–æ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω.")
        return
    
    # Get or create Telegram user
    telegram_user = await get_or_create_telegram_user(
        bot=bot,
        telegram_id=user.id,
        username=user.username,
        first_name=user.first_name,
        last_name=user.last_name
    )
    
    # Check if user is blocked
    if telegram_user.status == 'blocked':
        await message.answer("‚ùå –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.")
        return
    
    # Get or create chat session
    session = await state.get_data()
    if not session.get('chat_session_id'):
        # Create new session
        chat_session = await create_chat_session(bot, telegram_user)
        await state.update_data(chat_session_id=str(chat_session.id))
    else:
        from apps.chat.models import ChatSession
        chat_session = await sync_to_async(ChatSession.objects.get)(
            id=session['chat_session_id']
        )
    
    # Show "typing..." indicator
    await message.bot.send_chat_action(message.chat.id, "typing")
    
    try:
        # Process message (extract text from text/audio/files)
        processed_content = await process_message(
            message=message,
            bot=bot
        )
        
        # Save user message
        await save_chat_message(
            session=chat_session,
            role='user',
            content=processed_content,
            attachments={
                'has_audio': message.voice is not None or message.audio is not None,
                'has_document': message.document is not None,
                'has_photo': message.photo is not None
            }
        )
        
        # Get chat history
        history = await get_chat_history(chat_session, limit=10)
        
        # Generate bot response using Gemini
        response = await generate_bot_response(
            bot=bot,
            prompt=processed_content,
            history=history
        )
        
        # Save bot response
        await save_chat_message(
            session=chat_session,
            role='model',
            content=response['text'],
            is_thinking=False,
            attachments={
                'grounding_chunks': response.get('groundingChunks', [])
            }
        )
        
        # Send response
        await message.answer(response['text'])
        
    except Exception as e:
        import logging
        logger = logging.getLogger(__name__)
        logger.error(f"Error processing message: {str(e)}", exc_info=True)
        await message.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
```

### 6. Message Processor Service

**–ü—Ä–∞–≤–∏–ª–∞:**
- –í—ã–Ω–æ—Å–∏ –ª–æ–≥–∏–∫—É –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π service
- –î–ª—è –∞—É–¥–∏–æ: –∏—Å–ø–æ–ª—å–∑—É–π backend transcription service
- –î–ª—è —Ñ–∞–π–ª–æ–≤: –∏—Å–ø–æ–ª—å–∑—É–π backend file_processing service

**–ü—Ä–∏–º–µ—Ä:**
```python
# services/message_processor.py
from aiogram.types import Message
from typing import Optional
import aiohttp
import os

DJANGO_API_URL = os.getenv('DJANGO_API_URL', 'http://localhost:8000/api/v1')

async def process_message(message: Message, bot) -> str:
    """
    Process incoming message and extract text content.
    
    Handles:
    - Text messages: return text directly
    - Audio/Voice: transcribe using backend API
    - Files/Documents: extract text using backend API
    - Photos: extract text using OCR (if needed)
    
    Returns:
        Processed text content
    """
    if message.text:
        return message.text
    
    if message.voice or message.audio:
        # Download audio file
        file = message.voice or message.audio
        file_info = await message.bot.get_file(file.file_id)
        
        # Download file content
        audio_bytes = await message.bot.download_file(file_info.file_path)
        
        # Send to backend for transcription
        async with aiohttp.ClientSession() as session:
            form_data = aiohttp.FormData()
            form_data.add_field('audio_file', audio_bytes, filename='voice.ogg')
            form_data.add_field('audio_format', 'ogg')
            
            async with session.post(
                f'{DJANGO_API_URL}/chat/transcribe/',
                data=form_data,
                timeout=aiohttp.ClientTimeout(total=30)
            ) as response:
                if response.status == 200:
                    result = await response.json()
                    return result.get('text', '')
                else:
                    error = await response.json()
                    raise Exception(f"Transcription failed: {error.get('error', 'Unknown error')}")
    
    if message.document:
        # Download document
        file_info = await message.bot.get_file(message.document.file_id)
        file_bytes = await file_info.read()
        
        # Send to backend for processing
        async with aiohttp.ClientSession() as session:
            form_data = aiohttp.FormData()
            form_data.add_field('file', file_bytes, filename=message.document.file_name)
            
            async with session.post(
                f'{DJANGO_API_URL}/chat/process-file/',
                data=form_data,
                timeout=aiohttp.ClientTimeout(total=60)
            ) as response:
                if response.status == 200:
                    result = await response.json()
                    return result.get('text', '')
                else:
                    error = await response.json()
                    raise Exception(f"File processing failed: {error.get('error', 'Unknown error')}")
    
    if message.photo:
        # For photos, return caption or placeholder
        return message.caption or "[–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ]"
    
    return ""
```

### 7. Gemini Client Integration

**–ü—Ä–∞–≤–∏–ª–∞:**
- –ò—Å–ø–æ–ª—å–∑—É–π backend/services/gemini.py –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤
- –ú–æ–∂–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–ø—Ä—è–º—É—é –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ API
- –ü–µ—Ä–µ–¥–∞–≤–∞–π bot configuration (system_instruction, temperature, thinking_budget)

**–ü—Ä–∏–º–µ—Ä:**
```python
# services/gemini_client.py
from typing import List, Dict, Optional
import os
import sys

# Add backend to path for imports
backend_path = os.path.join(os.path.dirname(__file__), '..', '..', 'backend')
sys.path.insert(0, backend_path)

# Initialize Django
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'bot_factory.settings.development')
import django
django.setup()

from services.gemini import get_gemini_service
from services.knowledge_service import get_bot_knowledge_base

async def generate_bot_response(
    bot,
    prompt: str,
    history: List[Dict[str, str]] = None
) -> Dict[str, str]:
    """
    Generate bot response using Gemini API.
    
    Args:
        bot: Bot model instance
        prompt: User prompt
        history: Chat history as list of {role, content} dicts
        
    Returns:
        Dict with 'text' and optional 'groundingChunks'
    """
    # Get knowledge base for bot
    knowledge_base = await get_bot_knowledge_base(str(bot.id))
    
    # Build system instruction with knowledge base
    system_instruction = bot.system_instruction or "You are a helpful AI assistant."
    
    if knowledge_base['snippets'] or knowledge_base['documents']:
        knowledge_context = []
        
        # Add snippets
        if knowledge_base['snippets']:
            knowledge_context.append("\n\n## üìö Knowledge Base:")
            for snippet in knowledge_base['snippets']:
                knowledge_context.append(f"\n### {snippet['title']}")
                knowledge_context.append(snippet['content'])
                if snippet.get('tags'):
                    knowledge_context.append(f"Tags: {', '.join(snippet['tags'])}")
        
        # Add document summaries
        if knowledge_base['documents']:
            knowledge_context.append("\n\n## üìÑ Available Documents:")
            for doc in knowledge_base['documents']:
                knowledge_context.append(f"- {doc['name']} ({doc['type']})")
        
        system_instruction = f"{system_instruction}\n\n{''.join(knowledge_context)}"
    
    # Use sync_to_async for Django service
    from asgiref.sync import sync_to_async
    
    @sync_to_async
    def _generate_response():
        gemini_service = get_gemini_service()
        return gemini_service.generate_response(
            model_name=bot.model or 'gemini-2.5-flash',
            prompt=prompt,
            system_instruction=system_instruction,
            history=history or [],
            thinking_budget=bot.thinking_budget,
            temperature=bot.temperature or 0.7
        )
    
    result = await _generate_response()
    return result
```

### 8. Filters (–ö–∞—Å—Ç–æ–º–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã)

**–ü—Ä–∞–≤–∏–ª–∞:**
- –°–æ–∑–¥–∞–≤–∞–π –∫–∞—Å—Ç–æ–º–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
- –ò—Å–ø–æ–ª—å–∑—É–π —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ ownership –±–æ—Ç–∞

**–ü—Ä–∏–º–µ—Ä:**
```python
# bot_factory_bot/filters.py
from aiogram.filters import BaseFilter
from aiogram.types import Message
from integrations.django_orm import get_bot_by_token
from typing import Optional

class ActiveBotFilter(BaseFilter):
    """Filter to check if bot is active."""
    
    async def __call__(self, message: Message) -> bool:
        """Check if bot is active."""
        bot_token = message.bot.token
        bot = await get_bot_by_token(bot_token)
        return bot is not None

class UserNotBlockedFilter(BaseFilter):
    """Filter to check if user is not blocked."""
    
    async def __call__(self, message: Message) -> bool:
        """Check if user is not blocked."""
        from integrations.django_orm import get_or_create_telegram_user
        from integrations.django_orm import get_bot_by_token
        
        bot_token = message.bot.token
        bot = await get_bot_by_token(bot_token)
        if not bot:
            return False
        
        telegram_user = await get_or_create_telegram_user(
            bot=bot,
            telegram_id=message.from_user.id,
            first_name=message.from_user.first_name
        )
        
        return telegram_user.status == 'active'
```

### 9. Middleware

**–ü—Ä–∞–≤–∏–ª–∞:**
- –ò—Å–ø–æ–ª—å–∑—É–π middleware –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è, rate limiting, error handling
- –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π middleware –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ

**–ü—Ä–∏–º–µ—Ä:**
```python
# bot_factory_bot/middleware.py
from typing import Callable, Dict, Any, Awaitable
from aiogram import BaseMiddleware
from aiogram.types import TelegramObject
import logging
import time
from collections import defaultdict

logger = logging.getLogger(__name__)

class LoggingMiddleware(BaseMiddleware):
    """Middleware for logging all updates."""
    
    async def __call__(
        self,
        handler: Callable[[TelegramObject, Dict[str, Any]], Awaitable[Any]],
        event: TelegramObject,
        data: Dict[str, Any]
    ) -> Any:
        """Log update before handling."""
        start_time = time.time()
        
        # Log update
        logger.info(f"Update received: {type(event).__name__}")
        
        try:
            result = await handler(event, data)
            elapsed = time.time() - start_time
            logger.info(f"Update processed in {elapsed:.2f}s")
            return result
        except Exception as e:
            elapsed = time.time() - start_time
            logger.error(f"Error processing update after {elapsed:.2f}s: {str(e)}", exc_info=True)
            raise

class RateLimitMiddleware(BaseMiddleware):
    """Middleware for rate limiting user messages."""
    
    def __init__(self, max_messages: int = 10, window: int = 60):
        """
        Args:
            max_messages: Maximum messages per window
            window: Time window in seconds
        """
        self.max_messages = max_messages
        self.window = window
        self.user_messages: Dict[int, list] = defaultdict(list)
    
    async def __call__(
        self,
        handler: Callable[[TelegramObject, Dict[str, Any]], Awaitable[Any]],
        event: TelegramObject,
        data: Dict[str, Any]
    ) -> Any:
        """Rate limit check."""
        if hasattr(event, 'from_user') and event.from_user:
            user_id = event.from_user.id
            current_time = time.time()
            
            # Clean old messages
            self.user_messages[user_id] = [
                msg_time for msg_time in self.user_messages[user_id]
                if current_time - msg_time < self.window
            ]
            
            # Check rate limit
            if len(self.user_messages[user_id]) >= self.max_messages:
                if hasattr(event, 'answer'):
                    await event.answer(
                        f"‚è≥ –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–¥–æ–∂–¥–∏—Ç–µ {self.window} —Å–µ–∫—É–Ω–¥."
                    )
                return
            
            # Add current message
            self.user_messages[user_id].append(current_time)
        
        return await handler(event, data)
```

### 10. Keyboards (–ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã)

**–ü—Ä–∞–≤–∏–ª–∞:**
- –ò—Å–ø–æ–ª—å–∑—É–π InlineKeyboardBuilder –¥–ª—è inline –∫–Ω–æ–ø–æ–∫
- –ò—Å–ø–æ–ª—å–∑—É–π ReplyKeyboardMarkup –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
- –ì—Ä—É–ø–ø–∏—Ä—É–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –ø–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

**–ü—Ä–∏–º–µ—Ä:**
```python
# keyboards/main.py
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton

def get_main_menu() -> InlineKeyboardMarkup:
    """Get main menu keyboard."""
    builder = InlineKeyboardBuilder()
    builder.add(InlineKeyboardButton(text="üí¨ –ù–∞—á–∞—Ç—å —á–∞—Ç", callback_data="start_chat"))
    builder.add(InlineKeyboardButton(text="‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏", callback_data="settings"))
    builder.add(InlineKeyboardButton(text="‚ÑπÔ∏è –ü–æ–º–æ—â—å", callback_data="help"))
    builder.adjust(1)  # One button per row
    return builder.as_markup()

def get_settings_menu() -> InlineKeyboardMarkup:
    """Get settings menu keyboard."""
    builder = InlineKeyboardBuilder()
    builder.add(InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥", callback_data="main_menu"))
    return builder.as_markup()
```

### 11. FSM States (–°–æ—Å—Ç–æ—è–Ω–∏—è)

**–ü—Ä–∞–≤–∏–ª–∞:**
- –ò—Å–ø–æ–ª—å–∑—É–π FSM –¥–ª—è –º–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤
- –ì—Ä—É–ø–ø–∏—Ä—É–π —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

**–ü—Ä–∏–º–µ—Ä:**
```python
# states/chat.py
from aiogram.fsm.state import State, StatesGroup

class ChatStates(StatesGroup):
    """Chat FSM states."""
    waiting_for_message = State()
    processing_response = State()
```

---

## üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Django Backend

### 1. Django Settings Setup

**–ü—Ä–∞–≤–∏–ª–∞:**
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–π Django settings –ø–µ—Ä–µ–¥ –∏–º–ø–æ—Ä—Ç–æ–º –º–æ–¥–µ–ª–µ–π
- –ò—Å–ø–æ–ª—å–∑—É–π —Ç–µ –∂–µ settings, —á—Ç–æ –∏ –≤ backend
- –°–æ–∑–¥–∞–π –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–æ–¥—É–ª—å –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Django

**–ü—Ä–∏–º–µ—Ä:**
```python
# integrations/django_setup.py
import os
import sys
import django
from pathlib import Path

def setup_django():
    """Setup Django for bot usage."""
    # Get backend directory
    backend_dir = Path(__file__).resolve().parent.parent.parent / 'backend'
    
    # Add backend to path
    sys.path.insert(0, str(backend_dir))
    
    # Set Django settings
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'bot_factory.settings.development')
    
    # Initialize Django
    django.setup()
```

### 2. Django ORM Access

**–ü—Ä–∞–≤–∏–ª–∞:**
- –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π `sync_to_async` –¥–ª—è Django ORM –æ–ø–µ—Ä–∞—Ü–∏–π
- –°–æ–∑–¥–∞–≤–∞–π async wrappers –¥–ª—è —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π –∏—Å–∫–ª—é—á–µ–Ω–∏—è (ObjectDoesNotExist, etc.)

### 3. Backend Services Usage

**–ü—Ä–∞–≤–∏–ª–∞:**
- –ú–æ–∂–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å backend services –Ω–∞–ø—Ä—è–º—É—é
- –ò—Å–ø–æ–ª—å–∑—É–π `sync_to_async` –¥–ª—è –≤—ã–∑–æ–≤–∞ sync —Ñ—É–Ω–∫—Ü–∏–π
- –î–ª—è HTTP API: –∏—Å–ø–æ–ª—å–∑—É–π aiohttp –∏–ª–∏ httpx

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### 1. Token Security

**–ü—Ä–∞–≤–∏–ª–∞:**
- –•—Ä–∞–Ω–∏ telegram tokens –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
- –ù–µ –ª–æ–≥–∏—Ä—É–π —Ç–æ–∫–µ–Ω—ã
- –í–∞–ª–∏–¥–∏—Ä—É–π —Ç–æ–∫–µ–Ω—ã –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º

### 2. User Authentication

**–ü—Ä–∞–≤–∏–ª–∞:**
- –ü—Ä–æ–≤–µ—Ä—è–π —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (active/blocked) –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π —Å–æ–æ–±—â–µ–Ω–∏–π
- –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–π –¥–æ—Å—Ç—É–ø –∫ –∞–¥–º–∏–Ω—Å–∫–∏–º —Ñ—É–Ω–∫—Ü–∏—è–º
- –ò—Å–ø–æ–ª—å–∑—É–π rate limiting –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç —Å–ø–∞–º–∞

### 3. Error Handling

**–ü—Ä–∞–≤–∏–ª–∞:**
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π –≤—Å–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
- –ù–µ —Ä–∞—Å–∫—Ä—ã–≤–∞–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—à–∏–±–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
- –õ–æ–≥–∏—Ä—É–π –æ—à–∏–±–∫–∏ –¥–ª—è debugging

---

## üìù Naming Conventions

### Python

- **–ö–ª–∞—Å—Å—ã:** PascalCase (`BotService`, `MessageProcessor`)
- **–§—É–Ω–∫—Ü–∏–∏/–º–µ—Ç–æ–¥—ã:** snake_case (`get_user_bot`, `process_message`)
- **–ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã:** UPPER_SNAKE_CASE (`MAX_MESSAGE_LENGTH`)
- **–ü—Ä–∏–≤–∞—Ç–Ω—ã–µ –º–µ—Ç–æ–¥—ã:** —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `_` (`_internal_method`)

### aiogram

- **Routers:** snake_case + `_router` (`start_router`, `chat_router`)
- **Handlers:** snake_case (`cmd_start`, `handle_message`)
- **Filters:** PascalCase + Filter (`ActiveBotFilter`)
- **Middleware:** PascalCase + Middleware (`LoggingMiddleware`)

### Files

- `handlers/`, `services/`, `keyboards/` ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
- `models.py`, `views.py` ‚Äî —Ç–æ–ª—å–∫–æ –≤ Django apps
- `config.py`, `dispatcher.py` ‚Äî –≤ –≥–ª–∞–≤–Ω–æ–º –ø–∞–∫–µ—Ç–µ –±–æ—Ç–∞

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤

```python
# tests/test_handlers.py
import pytest
from aiogram.types import Message, User, Chat
from handlers.start import cmd_start

@pytest.mark.asyncio
async def test_cmd_start():
    """Test /start command handler."""
    # Mock message
    message = Message(
        message_id=1,
        date=1234567890,
        chat=Chat(id=1, type="private"),
        from_user=User(id=1, is_bot=False, first_name="Test")
    )
    
    # Test handler
    # ...
```

---

## üöÄ Deployment

### Virtual Environment Setup (–í–ê–ñ–ù–û!)

**–ò—Å–ø–æ–ª—å–∑—É–π `uv` –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è venv:**
```bash
# –°–æ–∑–¥–∞–Ω–∏–µ venv
cd bot/
uv venv .venv --python 3.11

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è
source .venv/bin/activate

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
uv pip install -r requirements.txt

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è Django ORM
uv pip install pgvector numpy google-generativeai langchain langchain-text-splitters langchain-google-genai
```

**–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π `virtualenv` –Ω–∞–ø—Ä—è–º—É—é** ‚Äî –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å —Å–ª–æ–º–∞–Ω–Ω—ã–π venv —Å pip, —É–∫–∞–∑—ã–≤–∞—é—â–∏–º –Ω–∞ —Å–∏—Å—Ç–µ–º–Ω—ã–π Python.

### Environment Variables

```bash
# .env
TELEGRAM_BOT_TOKEN=your_telegram_bot_token
DJANGO_API_URL=http://localhost:8000/api/v1
DJANGO_SETTINGS_MODULE=bot_factory.settings.development
LOG_LEVEL=INFO
GEMINI_API_KEY=your_gemini_api_key
```

### Running Bot

```python
# main.py
import asyncio
import logging
from aiogram import Bot, Dispatcher
from aiogram.client.default import DefaultBotProperties
from aiogram.enums import ParseMode
from bot_factory_bot.config import BOT_TOKEN
from bot_factory_bot.dispatcher import setup_dispatcher
from integrations.django_setup import setup_django

# Setup Django
setup_django()

# Setup logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)

async def main():
    """Main function to run bot."""
    # Initialize bot
    bot = Bot(
        token=BOT_TOKEN,
        default=DefaultBotProperties(parse_mode=ParseMode.HTML)
    )
    
    # Initialize dispatcher
    dp = Dispatcher()
    dp = setup_dispatcher(dp)
    
    # Start polling
    await dp.start_polling(bot)

if __name__ == '__main__':
    asyncio.run(main())
```

---

## üéØ Best Practices

### 1. Code Quality

- –ò—Å–ø–æ–ª—å–∑—É–π type hints –¥–ª—è –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π
- –ò—Å–ø–æ–ª—å–∑—É–π docstrings –¥–ª—è –≤—Å–µ—Ö –∫–ª–∞—Å—Å–æ–≤ –∏ —Ñ—É–Ω–∫—Ü–∏–π
- –°–ª–µ–¥—É–π PEP 8
- –ò—Å–ø–æ–ª—å–∑—É–π `black` –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- –ò—Å–ø–æ–ª—å–∑—É–π `ruff` –∏–ª–∏ `flake8` –¥–ª—è –ª–∏–Ω—Ç–∏–Ω–≥–∞

### 2. Performance

- –ò—Å–ø–æ–ª—å–∑—É–π `sync_to_async` –ø—Ä–∞–≤–∏–ª—å–Ω–æ (–Ω–µ –±–ª–æ–∫–∏—Ä—É–π event loop)
- –ò—Å–ø–æ–ª—å–∑—É–π connection pooling –¥–ª—è HTTP –∫–ª–∏–µ–Ω—Ç–æ–≤
- –ö—ç—à–∏—Ä—É–π —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ (bot config, knowledge base)
- –ò—Å–ø–æ–ª—å–∑—É–π rate limiting –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç —Å–ø–∞–º–∞

### 3. Error Handling

- –í—Å–µ–≥–¥–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–π –∏—Å–∫–ª—é—á–µ–Ω–∏—è
- –õ–æ–≥–∏—Ä—É–π –æ—à–∏–±–∫–∏ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
- –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–π –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º

### 4. Testing

- –ü–∏—à–∏ —Ç–µ—Å—Ç—ã –¥–ª—è handlers
- –ò—Å–ø–æ–ª—å–∑—É–π mocks –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- –¢–µ—Å—Ç–∏—Ä—É–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å Django ORM

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ü—Ä–∞–≤–∏–ª–∞

### 1. –ò–º–ø–æ—Ä—Ç—ã

```python
# –ü–æ—Ä—è–¥–æ–∫ –∏–º–ø–æ—Ä—Ç–æ–≤:
# 1. Standard library
import os
import logging
from typing import Optional, List, Dict

# 2. Third party
from aiogram import Router, F
from aiogram.types import Message
from aiogram.filters import Command

# 3. Django (–ø–æ—Å–ª–µ setup_django)
import django
from apps.bots.models import Bot

# 4. Local imports
from services.bot_service import get_user_bot
from keyboards.main import get_main_menu
```

### 2. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

```python
import logging

logger = logging.getLogger(__name__)

# –ò—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–Ω—ã–µ —É—Ä–æ–≤–Ω–∏
logger.debug("Debug message")
logger.info("Info message")
logger.warning("Warning message")
logger.error("Error message", exc_info=True)
```

### 3. Async/Await

```python
# –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π await –¥–ª—è async —Ñ—É–Ω–∫—Ü–∏–π
result = await async_function()

# –ù–µ –±–ª–æ–∫–∏—Ä—É–π event loop
# BAD: time.sleep(5)
# GOOD: await asyncio.sleep(5)

# –ò—Å–ø–æ–ª—å–∑—É–π sync_to_async –¥–ª—è Django ORM
from asgiref.sync import sync_to_async
result = await sync_to_async(DjangoModel.objects.get)(id=1)
```

---

## üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Backend Services

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Backend Services

**–í–∞—Ä–∏–∞–Ω—Ç 1: –ü—Ä—è–º–æ–π –∏–º–ø–æ—Ä—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)**
```python
# –ü–æ—Å–ª–µ setup_django()
from services.gemini import get_gemini_service
from services.transcription import transcribe_audio
from services.file_processing import extract_text_from_file

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ sync_to_async
@sync_to_async
def _generate_response(...):
    service = get_gemini_service()
    return service.generate_response(...)

result = await _generate_response(...)
```

**–í–∞—Ä–∏–∞–Ω—Ç 2: HTTP API**
```python
import aiohttp

async def generate_response_via_api(...):
    async with aiohttp.ClientSession() as session:
        async with session.post(
            f'{DJANGO_API_URL}/chat/generate/',
            json={...},
            timeout=aiohttp.ClientTimeout(total=60)
        ) as response:
            return await response.json()
```

### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ Bot Config

**–ü—Ä–æ–±–ª–µ–º–∞:** N+1 –∑–∞–ø—Ä–æ—Å –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –±–æ—Ç–∞ –ø–æ —Ç–æ–∫–µ–Ω—É (–¥–µ—à–∏—Ñ—Ä—É–µ—Ç –∫–∞–∂–¥—ã–π —Ç–æ–∫–µ–Ω)

**–†–µ—à–µ–Ω–∏–µ: Redis –∫—ç—à –¥–ª—è decrypted tokens:**
```python
import redis
import json
from typing import Optional

redis_client = redis.Redis.from_url(os.getenv('REDIS_URL', 'redis://localhost:6379/0'))
CACHE_TTL = 300  # 5 –º–∏–Ω—É—Ç

async def get_bot_by_token_cached(telegram_token: str) -> Optional[Bot]:
    """Get bot by token with Redis caching."""
    cache_key = f"bot:token:{telegram_token[:10]}"  # –ù–µ —Ö—Ä–∞–Ω–∏–º –ø–æ–ª–Ω—ã–π —Ç–æ–∫–µ–Ω
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
    cached = redis_client.get(cache_key)
    if cached:
        bot_id = json.loads(cached)['bot_id']
        return await sync_to_async(Bot.objects.get)(id=bot_id)
    
    # –ò—â–µ–º –≤ –ë–î
    bot = await get_bot_by_token(telegram_token)
    if bot:
        redis_client.setex(
            cache_key, 
            CACHE_TTL, 
            json.dumps({'bot_id': str(bot.id)})
        )
    
    return bot
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ API (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ ORM)

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ú–µ–Ω—å—à–µ —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç—å —Å Django –º–æ–¥–µ–ª—è–º–∏
- –ù–µ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å –±–æ—Ç–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –º–æ–¥–µ–ª–µ–π
- –ü—Ä–æ—â–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

**–ü—Ä–∏–º–µ—Ä:**
```python
# services/api_client.py
import httpx

class BackendAPIClient:
    def __init__(self, base_url: str, api_key: str = None):
        self.base_url = base_url
        self.api_key = api_key
    
    async def get_bot_by_token(self, token: str) -> dict:
        async with httpx.AsyncClient() as client:
            response = await client.get(
                f"{self.base_url}/bots/by-token/",
                params={"token": token},
                headers={"X-API-Key": self.api_key} if self.api_key else {}
            )
            return response.json()
```

---

## üé® Dynamic UI Configuration

### –û–±–∑–æ—Ä

Bot –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é UI —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (inline keyboards, —Ñ–æ—Ä–º—ã) –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–∑ Django backend. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ Bot –º–æ–¥–µ–ª–∏ –∏ –¥–æ—Å—Ç—É–ø–Ω–∞ —á–µ—Ä–µ–∑ API endpoints.

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ UI –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

**–í Bot –º–æ–¥–µ–ª–∏ (Django):**
- `ui_config` (JSONField): –û–±—â–∞—è UI –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- `default_inline_keyboard` (JSONField): –î–µ—Ñ–æ–ª—Ç–Ω–∞—è inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
- `welcome_message` (TextField): –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è /start
- `help_message` (TextField): –°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è /help

**JSON —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è inline keyboards:**
```json
{
  "inline_keyboards": {
    "main_menu": [
      [
        {"text": "üí¨ –ù–∞—á–∞—Ç—å —á–∞—Ç", "callback_data": "action_start_chat"},
        {"text": "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏", "callback_data": "action_settings"}
      ],
      [
        {"text": "‚ÑπÔ∏è –ü–æ–º–æ—â—å", "callback_data": "action_help"},
        {"text": "üåê –°–∞–π—Ç", "url": "https://example.com"}
      ]
    ]
  }
}
```

**JSON —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —Ñ–æ—Ä–º:**
```json
{
  "forms": {
    "feedback": {
      "name": "Feedback Form",
      "steps": [
        {
          "field": "name",
          "type": "text",
          "prompt": "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:",
          "required": true,
          "validation": {"min_length": 2, "max_length": 50}
        },
        {
          "field": "rating",
          "type": "choice",
          "prompt": "–û—Ü–µ–Ω–∏—Ç–µ –±–æ—Ç–∞ (1-5):",
          "options": ["1", "2", "3", "4", "5"],
          "required": true
        }
      ],
      "submit_handler": "save_feedback"
    }
  }
}
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Dynamic Keyboards

**–ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:**
```python
from bot.keyboards.dynamic import get_dynamic_keyboard, get_main_menu_keyboard

# –ü–æ–ª—É—á–∏—Ç—å –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
keyboard = await get_main_menu_keyboard(bot_token)

# –ü–æ–ª—É—á–∏—Ç—å –ª—é–±—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –ø–æ –∏–º–µ–Ω–∏
keyboard = await get_dynamic_keyboard(bot_id, 'settings_menu')

# –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:", reply_markup=keyboard)
```

**–°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –∏–∑ JSON:**
```python
from bot.utils.keyboard_builder import build_inline_keyboard

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (–∏–∑ Bot.ui_config)
config = [
    [{"text": "Button 1", "callback_data": "action1"}],
    [{"text": "Button 2", "url": "https://example.com"}]
]

keyboard = build_inline_keyboard(config)
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Dynamic Forms

**–ó–∞–ø—É—Å–∫ —Ñ–æ—Ä–º—ã –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:**
```python
from bot.handlers.forms import start_form

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É
await start_form(message, state, bot_token, 'feedback')
```

**–û–±—Ä–∞–±–æ—Ç–∫–∞ callback –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ñ–æ—Ä–º—ã:**
```python
@callbacks_router.callback_query(F.data == "action_form_feedback")
async def start_feedback_form(callback: CallbackQuery, state: FSMContext):
    from bot.handlers.forms import start_form
    await start_form(callback.message, state, callback.bot.token, 'feedback')
```

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–æ—Ä–º—ã –≤ handlers:**
```python
# –§–æ—Ä–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç FSM States –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
# –ö–∞–∂–¥—ã–π —à–∞–≥ —Ñ–æ—Ä–º—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–¥–Ω–æ–º—É State
# –î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ state.data['form_data']
```

### UIConfigService

**–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:**
```python
from bot.services.ui_config_service import get_ui_config_service

ui_service = get_ui_config_service()

# –ü–æ–ª—É—á–∏—Ç—å UI –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é (—Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
config = await ui_service.get_ui_config(bot_id)

# –ü–æ–ª—É—á–∏—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
keyboard_config = await ui_service.get_keyboard(bot_id, 'main_menu')

# –ü–æ–ª—É—á–∏—Ç—å —Ñ–æ—Ä–º—É
form_config = await ui_service.get_form(bot_id, 'feedback')

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –∫—ç—à
await ui_service.refresh_config(bot_id)

# –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à
ui_service.clear_cache(bot_id)
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Handlers

**start.py - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ welcome_message –∏ keyboard:**
```python
from bot.integrations.django_orm import get_bot_by_token
from bot.keyboards.dynamic import get_main_menu_keyboard

@start_router.message(CommandStart())
async def cmd_start(message: Message, state: FSMContext):
    bot = await get_bot_by_token(message.bot.token)
    welcome_text = bot.welcome_message or "üëã –ü—Ä–∏–≤–µ—Ç!"
    keyboard = await get_main_menu_keyboard(message.bot.token)
    
    await message.answer(welcome_text, reply_markup=keyboard)
```

**callbacks.py - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö callback_data:**
```python
@callbacks_router.callback_query(F.data.startswith("action_"))
async def handle_dynamic_action(callback: CallbackQuery, state: FSMContext):
    action = callback.data
    
    if action == "action_start_chat":
        await callback.message.answer("üí¨ –ù–∞—á–Ω–µ–º —á–∞—Ç!")
    elif action.startswith("action_form_"):
        form_name = action.replace("action_form_", "")
        from bot.handlers.forms import start_form
        await start_form(callback.message, state, callback.bot.token, form_name)
```

### –í–∞–ª–∏–¥–∞—Ü–∏—è UI –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

**Backend –≤–∞–ª–∏–¥–∞—Ü–∏—è (Django):**
- UIConfigSerializer –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç inline_keyboards –∏ forms —Å—Ç—Ä—É–∫—Ç—É—Ä—É
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –≤ –∫–Ω–æ–ø–∫–∞—Ö –∏ —à–∞–≥–∞—Ö —Ñ–æ—Ä–º

**Frontend –≤–∞–ª–∏–¥–∞—Ü–∏—è:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –Ω–∞ backend
- –í–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è keyboards –∏ —Ñ–æ—Ä–º

### Best Practices

1. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑—É–π UIConfigService –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (TTL: 5 –º–∏–Ω—É—Ç)
2. **Fallback:** –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–π fallback –∑–Ω–∞—á–µ–Ω–∏—è (default keyboard, default messages)
3. **–í–∞–ª–∏–¥–∞—Ü–∏—è:** –í–∞–ª–∏–¥–∏—Ä—É–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –≤–≤–æ–¥ –≤ —Ñ–æ—Ä–º–∞—Ö –∏—Å–ø–æ–ª—å–∑—É—è validate_form_step
4. **–ò–º–µ–Ω–æ–≤–∞–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑—É–π –ø–æ–Ω—è—Ç–Ω—ã–µ –∏–º–µ–Ω–∞ –¥–ª—è keyboards –∏ —Ñ–æ—Ä–º (main_menu, settings_menu, feedback_form)
5. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:** –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π —Å–ª—É—á–∞–∏, –∫–æ–≥–¥–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω–∞

---

---

## üéì Learning Resources

- **aiogram 3.x:** https://docs.aiogram.dev/
- **Django ORM:** https://docs.djangoproject.com/en/stable/topics/db/
- **asgiref:** https://github.com/django/asgiref
- **Python Async:** https://docs.python.org/3/library/asyncio.html

---

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –í–æ–ø—Ä–æ—Å—ã

–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –∏–ª–∏ –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö ‚Äî —Å–ª–µ–¥—É–π –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º, —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –≤ –∫–æ–¥–æ–≤–æ–π –±–∞–∑–µ. Consistency > Innovation.

---

## üì¶ –ù–æ–≤—ã–µ –ú–æ–¥—É–ª–∏ (Dynamic UI Integration)

### integrations/
- **django_setup.py**: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Django –¥–ª—è bot
- **django_orm.py**: Async wrappers –¥–ª—è Django ORM –æ–ø–µ—Ä–∞—Ü–∏–π

### services/
- **ui_config_service.py**: –°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å UI –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π (–∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ, –ø–æ–ª—É—á–µ–Ω–∏–µ)

### utils/
- **keyboard_builder.py**: –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ inline/reply keyboards –∏–∑ JSON
- **form_builder.py**: –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ñ–æ—Ä–º –∏–∑ JSON

### keyboards/
- **dynamic.py**: –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö keyboards –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### states/
- **dynamic_forms.py**: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ FSM States –¥–ª—è —Ñ–æ—Ä–º –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### handlers/
- **start.py**: /start handler —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º welcome_message –∏ keyboard
- **commands.py**: /help handler —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º help_message
- **callbacks.py**: –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö callback queries
- **forms.py**: –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π handler –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö —Ñ–æ—Ä–º

---

---

## üê≥ –ó–∞–ø—É—Å–∫ —Å Docker

### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

**–ó–∞–ø—É—Å–∫ backend —Å–µ—Ä–≤–∏—Å–æ–≤:**
```bash
# –ò–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞
docker-compose up -d postgres redis

# –ü—Ä–æ–≤–µ—Ä–∫–∞
docker-compose ps
```

**–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞:**
```bash
cd bot/
source .venv/bin/activate
PYTHONPATH=/path/to/bot-factory python main.py
```

### Production

**Dockerfile –¥–ª—è –±–æ—Ç–∞:**
```dockerfile
FROM python:3.11-slim

WORKDIR /app

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ uv
RUN pip install uv

# –ö–æ–ø–∏—Ä—É–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
COPY bot/requirements.txt .
RUN uv pip install --system -r requirements.txt

# –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–¥
COPY bot/ ./bot/
COPY backend/ ./backend/

ENV PYTHONPATH=/app
ENV DJANGO_SETTINGS_MODULE=bot_factory.settings.production

CMD ["python", "bot/main.py"]
```

---

**–í–µ—Ä—Å–∏—è:** 1.2
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-12-25
**–ò–∑–º–µ–Ω–µ–Ω–∏—è:** –î–æ–±–∞–≤–ª–µ–Ω uv –¥–ª—è venv, –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ, Docker, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ API
