# Bot Factory - Testing Guide

## Проверка функционалов

### 1. Сохранение токена бота

**Проблема была:** Токен не сохранялся из-за строгой валидации regex.

**Исправлено:**
- Frontend: Валидация теперь позволяет пустые токены
- Backend: Добавлена валидация формата токена в serializers

**Проверка:**
1. Откройте настройки бота
2. Введите токен в формате `123456789:ABC...`
3. Сохраните бота
4. Перезагрузите страницу - токен должен сохраниться

### 2. Тестирование подключения

**Проблема была:** Уведомление отправлялось не на того бота.

**Исправлено:**
- Уведомление теперь опциональное
- Если пользователь не начал диалог с ботом, показывается подсказка
- Тест считается успешным даже если уведомление не отправилось

**Проверка:**
1. Добавьте токен бота
2. Нажмите "Test Connection"
3. Должно показать успех даже если уведомление не отправлено

### 3. API Документация

**Доступна по адресам:**
- Swagger UI: http://localhost:8000/api/docs/
- ReDoc: http://localhost:8000/api/redoc/
- OpenAPI Schema: http://localhost:8000/api/schema/

**Проверка:**
1. Откройте http://localhost:8000/api/docs/
2. Должна отобразиться интерактивная документация
3. Можно тестировать endpoints прямо в браузере

### 4. Публичный API

**Endpoint:** `POST /api/v1/public/chat/`

**Аутентификация:** `X-API-Key: <bot_api_key>`

**Создание API ключа:**
1. Откройте настройки бота
2. Перейдите на вкладку "Integrations"
3. Создайте API ключ
4. Сохраните ключ (показывается только один раз!)

**Тестирование:**
```bash
curl -X POST http://localhost:8000/api/v1/public/chat/ \
  -H "X-API-Key: bf_your-api-key-here" \
  -H "Content-Type: application/json" \
  -d '{"message": "Hello!"}'
```

### 5. RAG (Retrieval Augmented Generation)

**Функционал:**
- При загрузке документа автоматически создаются embeddings
- При создании/обновлении сниппета автоматически создаётся embedding
- При генерации ответа ищутся релевантные chunks из документов и сниппетов
- Найденный контекст добавляется в system instruction

**Проверка:**
1. Загрузите документ (PDF, DOCX, TXT) для бота
2. Создайте текстовый сниппет
3. Отправьте сообщение боту, связанное с содержимым документа/сниппета
4. Бот должен использовать информацию из knowledge base

**Важно:** RAG требует PostgreSQL с pgvector. При использовании SQLite embeddings не будут работать.

### 6. Веб-доступ (Web Access)

**Настройка:**
1. Откройте настройки бота
2. Перейдите на вкладку "Model & AI"
3. Включите опцию "Enable Web Access" (если доступна)
4. Это позволяет боту использовать Google Search grounding

**Примечание:** Google Search grounding работает автоматически при использовании Gemini API с соответствующими настройками.

## Известные ограничения

1. **SQLite vs PostgreSQL:**
   - SQLite не поддерживает pgvector
   - Для RAG нужен PostgreSQL
   - Используйте Docker Compose для запуска PostgreSQL

2. **Embeddings:**
   - Генерация embeddings требует GEMINI_API_KEY
   - Может занять время для больших документов
   - Обрабатывается асинхронно в отдельном потоке

3. **Rate Limiting:**
   - Login: 5 попыток/минуту
   - Register: 3 регистрации/час
   - Public API: 100 запросов/минуту на API ключ

## Troubleshooting

### Токен не сохраняется
- Проверьте формат: должен быть `123456789:ABC...`
- Проверьте консоль браузера на ошибки валидации
- Проверьте логи backend

### RAG не работает
- Убедитесь что используется PostgreSQL
- Проверьте что документы обработаны (есть chunks)
- Проверьте что GEMINI_API_KEY установлен
- Проверьте логи на ошибки генерации embeddings

### API ключ не работает
- Убедитесь что ключ скопирован полностью
- Проверьте что бот активен
- Проверьте заголовок: `X-API-Key` (не `Authorization`)

